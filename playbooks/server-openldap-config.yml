---
  - name: Configure an OpenLDAP server for excercises 
    hosts: all
    become: yes
    gather_facts: no
    tasks:
      - name: Install the server package and other tools
        package:
          name: 
             - ldap-utils
             - slapd
          state: present
      
      - name: Stop the LDAP server
        service:
          name: slapd
          enabled: yes
          state: stopped

      - name: Purge the old config directory
        shell: 
          cmd: rm -rf /etc/ldap/slapd.d/*

      - name: Purge the old data directory
        shell: 
          cmd: rm -rf /var/lib/ldap/*

      - name: Copy the config template
        copy:
          src: /vagrant/files/slapd.conf.stub
          dest: /etc/ldap/slapd.conf.stub

      - name: Import the new configuration
        shell:
          cmd: /sbin/slaptest -n 0 -f /etc/ldap/slapd.conf.stub -F /etc/ldap/slapd.d 

      - name: Change the config ownership to the LDAP user
        file:
          path: /etc/ldap/slapd.d
          owner: openldap
          group: openldap
          recurse: yes

      - name: Create the certificate directory
        file:
          path: /etc/ldap/certs
          owner: openldap
          group: openldap
          mode: '0774'
          state: directory

      - name: Generate a private key for the LDAP server
        openssl_privatekey:
          path: /etc/ldap/certs/ldap_server.key
          state: present

      - name: Create a CSR for the LDAP server key
        openssl_csr:
          path: /etc/ldap/certs/ldap_server.csr
          privatekey_path: /etc/ldap/certs/ldap_server.key
          country_name: PL
          state_or_province_name: Slaskie
          locality_name: Katowice
          organization_name: Linux Lab
          common_name: server
          state: present

      - name: Issue the LDAP server certificate signed with the Lab CA key
        shell:
          cmd: openssl x509 -req -days 365 -CA /var/lib/ca/ca.crt -CAkey /var/lib/ca/ca.key -in /etc/ldap/certs/ldap_server.csr -out /etc/ldap/certs/ldap_server.crt

      - name: Copy the CA root certificate to the certificate directory of the LDAP server
        copy:
          src: /var/lib/ca/ca.crt
          dest: /etc/ldap/certs/ca.crt

      - name: Change the certificate directory ownership to the LDAP user
        file:
          path: /etc/ldap/certs
          owner: openldap
          group: openldap
          recurse: yes

      - name: Copy the CA root certificate to the NFS share /lab-certs
        copy:
          src: /var/lib/ca/ca.crt
          dest: /lab-certs/ca.crt

      - name: Enable and start the LDAP server
        service:
          name: slapd
          enabled: yes
          state: started

      - name: Create the monitor database
        shell:
          cmd: ldapadd -Y EXTERNAL -H ldapi:/// -f /vagrant/files/slapd-template-debian.ldif

      - name: Create the organization
        shell:
          cmd: ldapadd -Y EXTERNAL -H ldapi:/// -f /vagrant/files/organization.ldif
      
      - name: Create the containers
        shell:
          cmd: ldapadd -Y EXTERNAL -H ldapi:/// -f /vagrant/files/containers.ldif

      - name: Create an LDAP user
        shell:
          cmd: ldapadd -Y EXTERNAL -H ldapi:/// -f /vagrant/files/ldapuser.ldif

      - name: Set the LDAP user's password
        shell:
          cmd: ldappasswd -Y EXTERNAL -H ldapi:/// -s linux123 'uid=ldapuser,ou=users,dc=example,dc=com'

